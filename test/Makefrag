SM_TEST_DIR := $(realpath $(dir $(abspath $(lastword $(MAKEFILE_LIST)))))

SM_TEST_CFLAGS := -march=rv64g -mcmodel=medany -mabi=lp64 -fno-common -std=gnu11 -Wall -O0 -g

SM_TEST_LDFLAGS := -nostartfiles -nostdlib -static

SM_TEST_LD :=  $(SM_TEST_DIR)/test.lds
.INTERMEDIATE: $(SM_TEST_LD)

NULL_BOOT_BINARY := $(BUILD_DIR)/null_boot.bin
NULL_BOOT_ELF := $(BUILD_DIR)/null_boot.elf

SM_BINARY := $(BUILD_DIR)/sm.bin

BOOT_SRC := \
	$(SM_TEST_DIR)/null_boot_loader/boot.S \

$(NULL_BOOT_BINARY): $(NULL_BOOT_ELF)
	$(OBJCOPY) -O binary --only-section=.boot  $< $@

$(NULL_BOOT_ELF): $(BOOT_SRC) $(SM_TEST_LD) $(BUILD_DIR)
	$(CC) $(SM_CFLAGS) $(addprefix -I , $(SM_TEST_INCLUDES)) $(SM_TEST_LDFLAGS) -T $(SM_TEST_LD) $(BOOT_SRC) -o $@


SM_TEST_INCLUDES := \
	$(COMMON_DIR) \
	$(PLATFORM_DIR) \
	$(API_DIR) \
	$(SM_TEST_DIR) \

NULL_TEST_SRC := \
	$(COMMON_DIR)/htif/htif.c \
	$(SM_TEST_DIR)/test_entry.S \
	$(SM_TEST_DIR)/null_boot_loader/sm_keys.c \
	$(SM_TEST_DIR)/null_boot_loader/sm.S \
	$(SM_TEST_DIR)/unit_tests/null_test.c \

$(BUILD_DIR)/null_test.elf: $(NULL_TEST_SRC) $(SM_TEST_LD) $(BUILD_DIR) $(SM_BINARY)
	$(CC) $(SM_CFLAGS) $(addprefix -I , $(SM_TEST_INCLUDES)) $(SM_TEST_LDFLAGS) -T $(SM_TEST_LD) $(NULL_TEST_SRC) -D SM_BINARY_FILE=\"$(SM_BINARY)\" -o $@

.PHONY: null_test
null_test: $(BUILD_DIR)/null_test.elf

.PHONY: run_null_test
run_null_test: $(BUILD_DIR)/null_test.elf $(NULL_BOOT_BINARY)
	$(QEMU) $(QEMU_FLAGS) --kernel $(BUILD_DIR)/null_test.elf --bios $(NULL_BOOT_BINARY)
